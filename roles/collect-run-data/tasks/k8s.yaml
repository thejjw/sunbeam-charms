- name: microk8s inspect
  command:
    cmd: microk8s inspect
  become: true
- name: collect microk8s inspection report
  args:
    executable: /bin/bash
  shell: |
    cp /var/snap/microk8s/current/inspection-report-*.tar.gz "{{ zuul.project.src_dir }}/log/"
  failed_when: false
- name: debug describe pods
  args:
    executable: /bin/bash
  shell: |
    set -o pipefail
    microk8s.kubectl describe pods -A > {{ zuul.project.src_dir }}/log/describe-controller-pods.txt
    exit 0
- name: debug config maps
  args:
    executable: /bin/bash
  shell: |
    set -o pipefail
    microk8s.kubectl get cm -A -o yaml > {{ zuul.project.src_dir }}/log/config-maps.txt
    exit 0
- name: Collect pods logs
  args:
    executable: /bin/bash
  shell: |
    set -o pipefail
    LOG_FOLDER={{ zuul.project.src_dir }}/log/pods/
    MODEL_NAME=kube-system
    mkdir -p $LOG_FOLDER
    for pod in $(microk8s.kubectl get pods -n $MODEL_NAME -o=jsonpath='{.items[*].metadata.name}');
    do
      echo Collecting logs: $pod
      microk8s.kubectl logs --ignore-errors -n $MODEL_NAME --all-containers $pod > $LOG_FOLDER/$pod.log
    done
