#!/bin/bash
# Do not change this file, this file is managed by juju.

# set -e is important, to ensure the script bails out
# if there are issues, such as lock not acquired,
# or failure in one of the tempest steps.
set -ex

(flock -n 9 || (echo "lock could not be acquired"; exit 1)


rm -f "$TEMPEST_CONF~"
if [[ -e "$TEMPEST_CONF" ]]; then
    mv "$TEMPEST_CONF" "$TEMPEST_CONF~"
fi

discover-tempest-config --test-accounts "$TEMPEST_TEST_ACCOUNTS" --out "$TEMPEST_CONF"

if [[ -e "$TEMPEST_CONF~" ]]; then
    echo "tempest.conf regenerated, comparing with previous version:"
    python3 "$TEMPEST_HOME/config_diff.py" "$TEMPEST_CONF~" "$TEMPEST_CONF"
fi

TMP_FILE="$(mktemp)"
tempest run --workspace "$TEMPEST_WORKSPACE" "$@" 2>&1 | tee "$TMP_FILE"
mv "$TMP_FILE" "$TEMPEST_OUTPUT"

) 9>/var/lock/tempest
