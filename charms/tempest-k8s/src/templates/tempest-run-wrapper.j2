#!/bin/bash
# Do not change this file, this file is managed by juju.

(flock -n 9 || {
    # curly braces are important here, as they retain the same execution environment.
    # we don't want to start a new subshell
    echo "Lock could not be acquired, another test run is in progress."
    exit 1
}

# log everything to a tmpfile
TMP_FILE="$(mktemp)"

echo ":: discover-tempest-config" >> "$TMP_FILE"
if discover-tempest-config --test-accounts "$TEMPEST_TEST_ACCOUNTS" --out "$TEMPEST_CONF" >> "$TMP_FILE" 2>&1; then
    echo ":: tempest run" >> "$TMP_FILE"
    tempest run --workspace "$TEMPEST_WORKSPACE" "$@" >> "$TMP_FILE" 2>&1
else
    echo ":: skipping tempest run because discover-tempest-config had errors" >> "$TMP_FILE"
fi

# tempest and discover-tempest-config can output escape sequences,
# so remove them to neaten the output.
sed $'s/\033\[[0-9;]*m//g' -i "$TMP_FILE"

# After everything, move it to the actual output.
# This ensures we don't have issues with logging libs pushing partial files,
# if we were to stream to the final output.
mv "$TMP_FILE" "$TEMPEST_OUTPUT"

SUMMARY="$(awk '/^Totals$/,/Sum of execute/ { print }' < "$TEMPEST_OUTPUT")"
if [[ -n "$SUMMARY" ]]; then
    echo "$SUMMARY"
else
    echo "Error running the tests, please view the log file"
    exit 1
fi

) 9>/var/lock/tempest
