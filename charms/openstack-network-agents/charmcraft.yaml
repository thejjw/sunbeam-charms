type: charm
name: openstack-network-agents
title: OpenStack Network Agents (subordinate)
summary: Subordinate charm to drive the openstack-network-agents snap
description: |
  Installs and configures the 'openstack-network-agents' snap, sets up the
  provider bridge/physnet mapping, and runs neutron-ovn-metadata-agent.
  Attach this charm to MicroOVN units to provide north/south traffic.

base: ubuntu@24.04
subordinate: true

platforms:
  amd64:

requires:
  juju-info:
    interface: juju-info
    scope: container

config:
  options:
    snap-name:
      type: string
      default: openstack-network-agents
      description: Name of the snap to install.
    snap-channel:
      type: string
      default: latest/edge
      description: Snap channel to track.

    debug:
      type: boolean
      default: false

actions:
  set-network-agents-local-settings:
    description: |
      Apply settings specific to this unit for provider networking.
    params:
      external-interface:
        type: string
        description: |
          (Deprecated) Physical NIC to add as a bridge port (e.g. enp6s0).
      bridge-name:
        type: string
        description: |
          (Deprecated) Provider bridge name.
      physnet-name:
        type: string
        description: |
          (Deprecated) OVN physnet label.
      enable-chassis-as-gw:
        type: boolean
        description: |
          If true, set ovn-cms-options=enable-chassis-as-gw so L3 gateway roles
          prefer scheduling here.
      bridge-mapping:
        type: string
        description: |
          Space separated list of bridge:physnet:iface mappings. (br-ex:physnet1:ens3 ...)
    additionalProperties: false
  list-nics:
    description: |
      List host NICS, and which one are candidates for use as external NIC.
    additionalProperties: false

parts:
  charm:
    build-packages:
      - git
      - libffi-dev
      - libssl-dev
      - pkg-config
      - rustc-1.80
      - cargo-1.80
    charm-binary-python-packages:
      - cryptography
      - jsonschema
      - pydantic
      - jinja2
    build-snaps: [astral-uv]
    override-build: |
      uv export --frozen --no-hashes --format=requirements-txt -o requirements.txt
      craftctl default
    charm-requirements: [requirements.txt]
